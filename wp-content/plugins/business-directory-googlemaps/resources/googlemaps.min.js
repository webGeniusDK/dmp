var wpbdp=window.wpbdp||{};!function($){var googlemaps=wpbdp.googlemaps=wpbdp.googlemaps||{};googlemaps._maps=[],googlemaps.listeners={map_created:[],map_rendered:[]},googlemaps.refresh_all=function(){$.each(googlemaps._maps,function(i,map){map.refresh()})},googlemaps.Map=function(htmlID,settings){var args=[];this.MAP_TYPES={roadmap:google.maps.MapTypeId.ROADMAP,satellite:google.maps.MapTypeId.SATELLITE,hybrid:google.maps.MapTypeId.HYBRID,terrain:google.maps.MapTypeId.TERRAIN},this.$map=$("#"+htmlID),this.locations=[],this.settings=settings,"undefined"!=typeof this.settings.zoom_level&&"auto"!=this.settings.zoom_level&&(this.settings.zoom_level=parseInt(this.settings.zoom_level)),this.settings.removeEmpty=!0,this.bounds=new google.maps.LatLngBounds,args.mapTypeId=this.MAP_TYPES[this.settings.map_type],"undefined"!=typeof this.settings.map_id?args.mapId=this.settings.map_id:args.styles=this.settings.styles,this.GoogleMap=new google.maps.Map(this.$map[0],args),this.infoWindow=new google.maps.InfoWindow,this.oms=new OverlappingMarkerSpiderfier(this.GoogleMap,{markersWontMove:!0,markersWontHide:!0,keepSpiderfied:!0}),"1"===WPBDP_googlemaps_marker_cluster.is_marker_cluster_enabled&&(this.mc=new MarkerClusterer(this.GoogleMap,this.locations,{gridSize:40,imagePath:WPBDP_googlemaps_marker_cluster.markers_path,maxZoom:15})),this.rendered=!1;for(var i=0;i<googlemaps.listeners.map_created.length;i++)googlemaps.listeners.map_created[i](this);googlemaps._maps.push(this)},$.extend(googlemaps.Map.prototype,{_addMarker:function(place){var markerOpts;if("undefined"!=typeof place&&place&&"undefined"!=typeof place.geolocation&&place.geolocation&&"undefined"!=typeof place.geolocation.lat&&place.geolocation.lat&&"undefined"!=typeof place.geolocation.lng&&place.geolocation.lng){var position=new google.maps.LatLng(place.geolocation.lat,place.geolocation.lng);this.bounds.extend(position),markerOpts=place,delete markerOpts.url,delete markerOpts.title,markerOpts.map=this.GoogleMap,markerOpts.position=position,markerOpts.animation=this.settings.animate_markers?google.maps.Animation.DROP:null;var marker=new google.maps.Marker(markerOpts);marker.descriptionHTML=place.content.replace(/(?:\r\n|\r|\n)/g,"<br />"),this.oms.addMarker(marker),"1"===WPBDP_googlemaps_marker_cluster.is_marker_cluster_enabled&&this.mc.addMarker(marker)}},setLocations:function(locations){this.locations=locations},fitContainer:function(stretch,enlarge){if(this.settings.auto_resize&&"auto"!==this.settings.map_size){var parent_width=this.$map.parent().innerWidth(),current_width=this.$map.outerWidth();parent_width<current_width?this.$map.width(parent_width-2):parent_width>=this.orig_width&&this.$map.width(this.orig_width-2),this.refresh()}},refresh:function(){this.$map.is(":visible")&&(this.rendered?(this.$map.width(this.$map.parent().innerWidth()-2),google.maps.event.trigger(this.GoogleMap,"resize"),this.GoogleMap.setCenter(this.bounds.getCenter())):this.render())},render:function(){var i,map=this;this.orig_width=this.$map.width();var refElement=this.$map.parent().siblings(this.settings.position.element);if(0==refElement.length&&(refElement=this.$map.parent().siblings("div.listings"),this.settings.position.insertpos=""),"top"===this.settings.position.location&&("before"===this.settings.position.insertpos?this.$map.insertBefore(refElement):"after"===this.settings.position.insertpos?this.$map.insertAfter(refElement):this.$map.prependTo(refElement)),this.locations)for(i=0;i<this.locations.length;i++)this._addMarker(this.locations[i]);for(this.oms.addListener("click",function(marker,event){map.infoWindow.setContent(marker.descriptionHTML),map.infoWindow.open(map.GoogleMap,marker)}),this.oms.addListener("spiderfy",function(markers){map.infoWindow.close()}),"1"===WPBDP_googlemaps_marker_cluster.is_marker_cluster_enabled&&$(this.mc.getMarkers()).each(function(){google.maps.event.addListener(this,"click",function(){map.infoWindow.setContent(this.descriptionHTML),map.infoWindow.open(map.GoogleMap,this)})}),i=0;i<googlemaps.listeners.map_rendered.length;i++)googlemaps.listeners.map_rendered[i](this);this.settings.removeEmpty&&!this.locations&&this.$map.remove(),1==this.locations.length?"auto"!=this.settings.zoom_level?this.GoogleMap.setZoom(this.settings.zoom_level):this.GoogleMap.setZoom(15):this.GoogleMap.fitBounds(this.bounds),this.GoogleMap.setCenter(this.bounds.getCenter()),this.rendered=!0,$(window).on("resize",function(){map.fitContainer(!0,!1)}),map.fitContainer(!0,!1)}}),googlemaps.DirectionsHandler=function(map,$form,$display){if(0!=$form.length&&map.settings.listingID&&1==map.locations.length){this._map=map,this._$form=$form,this._$display=null,this.from=null,this.to=[map.locations[0].geolocation.lat,map.locations[0].geolocation.lng],this.travelMode=null,this._working=!1,this._error="";var t=this;t._$form.find(".find-route-btn").click(function(e){e.preventDefault(),t.startRouting()});var isNotSecureContext="undefined"!=typeof window.isSecureContext&&!window.isSecureContext;isNotSecureContext?(t._$form.find('input[name="from_mode"]').val("address").parent("label").hide(),t._$form.find('input[name="from_address"]').show()):t._$form.find('input[name="from_mode"]').change(function(e,focus){var $field=t._$form.find('input[name="from_address"]');"address"==$(this).val()&&"no-focus"===focus?$field.show():"address"===$(this).val()?$field.show().focus():$field.hide()}).filter(":checked").trigger("change","no-focus")}},$.extend(googlemaps.DirectionsHandler.prototype,{HTML_TEMPLATE:'<div id="wpbdp-map-directions-wrapper" style="display: none;"><div id="wpbdp-map-directions" class="cf"><div class="wpbdp-google-map route-map"></div><div class="directions-panel"></div></div></div>',TRAVEL_MODES:{driving:google.maps.TravelMode.DRIVING,cycling:google.maps.TravelMode.BICYCLING,transit:google.maps.TravelMode.TRANSIT,walking:google.maps.TravelMode.WALKING},error:function(msg){var t=this;"undefined"!=typeof msg&&msg||(msg=""),t._error=msg,t._working=!1,msg&&alert(t._error),t._$form.find(".find-route-btn").prop("disabled",!1).val(WPBDP_googlemaps_directions_l10n.submit_normal)},startRouting:function(){var t=this;if(!t._working){t._working=!0,t._$form.find(".find-route-btn").prop("disabled",!0).val(WPBDP_googlemaps_directions_l10n.submit_working),$("#wpbdp-map-directions-wrapper").remove(),t._$display=$(t.HTML_TEMPLATE).appendTo("body");var fromMode=t._$form.find('input[name="from_mode"]:checked').val(),address=$.trim(this._$form.find('input[name="from_address"]').val()),travelMode=t._$form.find('select[name="travel_mode"]').val();if("current"!=fromMode&&"address"!=fromMode)return void t.error();if("address"==fromMode&&!address)return void t.error();if("driving"!=travelMode&&"cycling"!=travelMode&&"walking"!=travelMode&&"transit"!=travelMode)return void t.error();t.travelMode=travelMode,"current"==fromMode?t.geolocate():t.geocode(address)}},geolocate:function(){var t=this;if(t._working)return navigator.geolocation?void navigator.geolocation.getCurrentPosition(function(pos){t.from=[pos.coords.latitude,pos.coords.longitude],t.displayRoute()},function(err){t.error(err.message)}):void t.error(WPBDP_googlemaps_directions_l10n.errors_no_route)},geocode:function(address){var t=this;t._working&&("undefined"==typeof t._geocoderService&&(t._geocoderService=new google.maps.Geocoder),t._geocoderService.geocode({address:address},function(results,status_){if(google.maps.GeocoderStatus.OK!==status_)return void t.error(WPBDP_googlemaps_directions_l10n.errors_no_route);var pos=results[0].geometry.location;t.from=[pos.lat(),pos.lng()],t.displayRoute()}))},displayRoute:function(){var directionsService,request,t=this;t._working&&(directionsService=new google.maps.DirectionsService,request={origin:new google.maps.LatLng(t.from[0],t.from[1]),destination:new google.maps.LatLng(t.to[0],t.to[1]),travelMode:t.TRAVEL_MODES[t.travelMode]},directionsService.route(request,function(route,status_){return google.maps.DirectionsStatus.OK!=status_?void t.error(WPBDP_googlemaps_directions_l10n.errors_no_route):(t.route=route,void t.showThickbox())}))},showThickbox:function(){var $directions,$thickboxTitle,width,height,contentHeight,t=this;if(t._working){width=$(window).width()-40,height=$(window).height()-40;var listingTitle=t._$form.find('input[name="listing_title"]').val(),title=WPBDP_googlemaps_directions_l10n["titles_"+t.travelMode].replace(/%s/g,listingTitle);tb_show(title,"#TB_inline?width="+width+"&height="+height+"&inlineId=wpbdp-map-directions-wrapper"),$directions=$("#wpbdp-map-directions"),$thickboxTitle=$directions.closest("#TB_window").find("#TB_title"),contentHeight=height-$thickboxTitle.outerHeight(),$directions.css({height:contentHeight}),$directions.closest("#TB_window").css({marginLeft:-Math.floor(width/2)+"px",marginTop:-Math.floor(height/2)+"px",width:width+"px"}),$directions.closest("#TB_ajaxContent").css({height:contentHeight,padding:0}),t.showMap($directions),t._working=!1,t._$form.find(".find-route-btn").prop("disabled",!1).val(WPBDP_googlemaps_directions_l10n.submit_normal)}},showMap:function($container){var mapOptions,map,directionsDisplay,self=this;mapOptions={zoom:7,center:new google.maps.LatLng(self.from[0],self.from[1]),mapTypeId:google.maps.MapTypeId.ROADMAP},map=new google.maps.Map($container.find(".route-map").get(0),mapOptions),directionsDisplay=new google.maps.DirectionsRenderer,directionsDisplay.setMap(map),directionsDisplay.setPanel($container.find(".directions-panel").get(0)),directionsDisplay.setDirections(self.route)}}),$(function(){"undefined"!=typeof WPBDP_googlemaps_data&&$('[id^="wpbdp-map-"]').each(function(){var uid=$(this).attr("id").replace("wpbdp-map-","");if("undefined"!=typeof WPBDP_googlemaps_data["map_"+uid]){var settings=WPBDP_googlemaps_data["map_"+uid].settings,locations=WPBDP_googlemaps_data["map_"+uid].locations,map=new wpbdp.googlemaps.Map("wpbdp-map-"+settings.map_uid,settings);if(map.setLocations(locations),map.render(),settings.with_directions){new wpbdp.googlemaps.DirectionsHandler(map,jQuery(".wpbdp-map-directions-config"))}}})})}(jQuery);